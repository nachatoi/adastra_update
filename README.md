# Обновление базы данных [ADASTRA](https://adastra.autosome.org/bill-cipher)

Пайплайн состоит из двух основных частей, выделенных на основе того, что именно они занимают 99% времени выполнения. 

1. Получение последовательностей, содержащих необходимые SNV. За это отвечает скрипт `asb.py` и `make_snps_list.sh`.
2. Поиск конкордантных и дискордантных мотивов. Для этого используются PERFECTOS-APE и скрипт `concordance.py`.

Все скрипты запускаются через один — `adastra_update.sh`. В нем же есть некоторые дополнительные программы, необходимые для дополнительной сортировки результатов и импортируемых файлов. 

## Вариабельные переменные

Можно настроить несколько основных параметров. 

* `file_list` — файл с путями к обрабатываемым файлам из [базы данных ADASTRA](https://adastra.autosome.org/bill-cipher/downloads). 
* `genome` — референсный геном, из которого будут извлекаться последовательности с SNV.
* `output` — название выходного файла с количествами конкордантных и дискордантных мотивов для отдельных транскрипционных факторов.
* `p_value` — пороговое значение P Value для определения конкордантности и дискордантности мотива.
* `threads` — количество используемых потоков (программа будет использовать в 4 раза больше). 
* `discr` — уровень дискретизации в [PERFECTOS-APE](https://opera.autosome.org/downloads/MACRO-PERFECTOS-APE_manual.pdf) (по умолчанию 1000, для более точных подсчетов рекомендуется выставить 10,000).

После их выставления можно запускать скрипт `adastra_update.sh`. Для его работы в одной директории с ним должны существовать: 

* Директория `scripts`, внутри нее все необходимые скрипты и [PERFECTOS-APE](https://opera.autosome.org/perfectosape) (при тестировании использовалась версия 3.0.6);
* Директория `hocomoco/v12/pwm` с матрицами весов для каждого транскрипционного фактора. 

В одной директории с этим скриптом будет создаваться множество промежуточных файлов, в конце работы скрипта они сами удалятся. Скрипт работает с каждым транскрипционным фактором по-отдельности. 

## Получение последовательностей, содержащих необходимые SNV 

Конкордантность мотива определяется двумя параметрами: 

* FDR — его значение не пересчитывалось, порогом приняли 5%. 
* Минимальный P Value. Это минимальный P Value из двух: для референсного аллеля и для альтернативного. [В оригинальной статьей](https://www.nature.com/articles/s41467-021-23007-0) его значение принято 0.0005, мы же подняли его до 0.001. 

Первым шагом все SNP из файла ADASTRA фильтровались по FDR (0.05) при помощи `asb.py`, чтобы в дальнейшем не работать с заведомо не конкордантными мотивами (полученный файл сохраняется с расширением .filtered). Дальше при помощи `make_snps_list.sh` вокруг выбранных SNV достраивалось по 30 нуклеотидов с каждой стороны при помощи `bedtools getfasta`. Итоговый файл с расширением .snps состоит из строк следующего формата: 

``` 
rs4742379       AGGTCTGGGGTAAAAAGGCAGAGCTCACT[C/G]CTAGTGATGCTAATCTCCTCTGGCCCACGA
```
## Предсказание связывания транскрипционных факторов с сайтами

Вероятность связывания транскрипционного фактора с сайтом предсказывалась при помощи SNPScan (инструмент PERFECTOS-APE, [стр. 10](https://opera.autosome.org/downloads/MACRO-PERFECTOS-APE_manual.pdf)). Для работы программе необходимы матрицы весов, которые мы взяли из базы данных [HOCOMOCO v12](https://hocomoco12.autosome.org/downloads_v12) из коллекции H12rSNP. Программа будет создавать файлы с разрешением .perfectos, которые будут складываться в директории `pwm_results_{index}`, где вместо index разные варианты мотивов из HOCOMOCO. Эта часть скрипта выполняется дольше всего, особенно при уровне дискретизации 10,000. 

## Поиск конкордантных и дискордантных мотивов

При помощи скрипта `concordance.py` по описанным выше критериям считается число конкордантных и дискордантных мотивов с использованием FDR из ADASTRA. На выходе создается TSV таблица с числами мотивов и сравнением с данными из ADASTRA. Итого на выходе четыре таблицы для четырех вариантов мотивов (если они есть у того или иного транскрипционного фактора) — `adastra_pwm_{index}.tsv`. 

Затем при помощи скрипта `adastra_pwm.py` четыре таблицы объединяются в одну — `adastra_pwm_{P Value}.tsv`. В ней для каждого транскрипционного фактора числа указаны только для того мотива, у которого наибольшая Δ. 

```
Δ = ((Количество конкордантных, ADASTRA) / (Дискордантных, ADASTRA)) — ((Конкордантных, SNPScan) / (Дискордантных, SNPScan))
```

Также есть два дополнительных скрипта, которые могут использоваться для подсчета конкордантных аллелей. Дело в том, что в зависимости от мотива транскрипционного фактора, один и тот же аллель может быть как конкордантным, так и дискордантным. Это можно учитывать двумя способами. 

1. Выбирать SNP, соответсвующий тому мотиву, у результатов которого наименьший P value (`process_results_1.py`).
2. Всегда выбирать конкордантный SNP (`process_results_2.py`).

На вход обоим скриптам нужно два аргумента: порого по P Value и путь до директории с файлами транскрипционных факторов из ADASTRA. Для работы этих скриптов основной скрипт `adastra_update.sh` создал директорию `filtered`. В ней лежат все файлы с расширением `.filtered`. 

## Формат выходных таблиц

В выходной таблице есть три группы столбцов: 

* Имеющие ADASTRA в названии: все числа в них считались на основе файлов из ADASTRA (столбец motif_conc). 
* Concordance, Discordance, Hit, No_hit — посчитаны на основе данных PERFECTOS-APE. 
* 0, 1, 2, 3 — указывают на то, какой по номеру мотив взят для данного транскрипционного фактора скриптом `adastra_pwm.py`.

| Factor | Adastra_concordance | Concordance | Adastra_discordance | Discordance | Adastra_hit | Hit | Adastra_no_hit | No_hit | 0 | 1 | 2 | 3 | 
| :-----: | :-----: | :-----: | :-----: | :-----: | :-----: | :-----: | :-----: | :-----: | :-----: | :-----: | :-----: | :-----: |
| FOXA2 | 211 | 274 | 23 | 39 | 234 | 314 | 1260 | 1180 | 1494 | 0 | 0 | 0 | 
| ATF3 | 62 | 111 | 19 | 24 | 81 | 136 | 650 | 595 | 0 | 0 | 731 | 0 | 
| CTCF | 4641 | 5033 | 1772 | 1773 | 6413 | 6853 | 23106 | 22735 | 29588 | 0 | 0 | 0 | 
| ANDR | 743 | 1212 | 491 | 814 | 1234 | 2031 | 21696 | 20901 | 22932 | 0 | 0 | 0 | 
